<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Roen Card Game - Fixed Layout</title>
    <style>
        :root {
            --fire-color: #FF7B7B; --water-color: #7B8CFF;
            --wind-color: #7BFFB8; --earth-color: #C19A6B;
            --card-width: 90px; --card-height: 130px;
        }
        body { background-color: #3D3D3D; color: #F0F0F0; font-family: sans-serif; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        .game-container { width: 100%; max-width: 1000px; display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        /* 【修正】グリッド配置を 6,5,4 / 3,2,1 の順に変更 */
        .field { 
            display: grid; 
            grid-template-areas: 
                "slot5 slot4 slot3" 
                "slot2 slot1 slot0"; 
            gap: 10px; padding: 20px; justify-content: center; background: rgba(0,0,0,0.2);
        }
        .card-slot { width: var(--card-width); height: var(--card-height); background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; justify-content: center; align-items: center; position: relative; }
        
        /* カードの基本デザイン */
        .card { width: 100%; height: 100%; border-radius: 8px; background: #ddd; color: #333; cursor: pointer; position: relative; box-sizing: border-box; border: 3px solid transparent; }
        .card.selected { border-color: yellow; box-shadow: 0 0 10px yellow; }
        .card.attacked { opacity: 0.6; filter: grayscale(0.8); } /* 攻撃済みはグレー */
        
        .player-hand { position: fixed; bottom: 0; left: 0; right: 0; height: 160px; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.6); gap: 10px; }
        .log-area { position: absolute; left: 10px; top: 10px; width: 220px; height: 200px; background: rgba(0,0,0,0.7); font-size: 12px; overflow-y: auto; padding: 10px; border-radius: 5px; }
        .center-area { display: flex; justify-content: space-around; align-items: center; background: #222; padding: 15px; }
        .game-button { padding: 10px 20px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="game-container">
    <div id="log-area" class="log-area"><strong>ログ</strong></div>
    
    <div class="opponent-area"><div id="opponent-field" class="field"></div></div>

    <div class="center-area">
        <div id="opp-status">相手HP: 20</div>
        <div id="controls">
            <button id="ok-btn" class="game-button">配置OK</button>
            <button id="end-turn-btn" class="game-button" style="display:none;">ターン終了</button>
        </div>
        <div id="ply-status">自分HP: 20</div>
    </div>

    <div class="player-area"><div id="player-field" class="field"></div></div>
    <div id="player-hand" class="player-hand"></div>
</div>

<script>
const RANK_VALUES = { 'A': 14, 'K': 13, 'Q': 12, 'J': 11, '9': 9, '8': 8, '6': 6, '4': 4, '3': 3 };

class Card {
    constructor(suit, rank) {
        this.id = Math.random().toString(36).substr(2, 9);
        this.suit = suit;
        this.rank = rank;
        this.value = RANK_VALUES[rank];
        this.hp = this.value;
        this.maxHp = this.value;
    }
}

const state = {
    player: { hand: [], field: Array(6).fill(null), attackedIds: [] },
    opponent: { field: Array(6).fill(null) },
    selectedCard: null,
    gameStarted: false,
    turn: 'player'
};

function addLog(msg) {
    const log = document.getElementById('log-area');
    log.innerHTML += `<div>・${msg}</div>`;
    log.scrollTop = log.scrollHeight;
}

function render() {
    renderField('player-field', state.player.field, false);
    renderField('opponent-field', state.opponent.field, true);
    
    const handEl = document.getElementById('player-hand');
    handEl.innerHTML = '';
    state.player.hand.forEach(card => {
        const el = createCardEl(card);
        el.onclick = () => { state.selectedCard = card; render(); };
        if (state.selectedCard === card) el.classList.add('selected');
        handEl.appendChild(el);
    });
}

function renderField(id, field, isOpponent) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    field.forEach((card, i) => {
        const slot = document.createElement('div');
        slot.className = 'card-slot';
        slot.style.gridArea = `slot${i}`;
        
        if (card) {
            const cardEl = createCardEl(card);
            // 攻撃済みなら暗くする
            if (!isOpponent && state.player.attackedIds.includes(card.id)) cardEl.classList.add('attacked');
            
            cardEl.onclick = (e) => {
                e.stopPropagation();
                if (isOpponent) handleAttack(card);
                else handleFieldClick(card, i);
            };
            slot.appendChild(cardEl);
        } else {
            slot.innerHTML = `<span style="opacity:0.3">${i + 1}</span>`;
            slot.onclick = () => placeCard(i);
        }
        el.appendChild(slot);
    });
}

function createCardEl(card) {
    const div = document.createElement('div');
    div.className = `card ${card.suit}`;
    div.innerHTML = `<div style="padding:5px; text-align:center;">
        <strong>${card.rank}</strong><br>
        <small>${card.suit}</small><br><br>
        HP: ${card.hp}/${card.maxHp}<br>
        ATK: ${card.value}
    </div>`;
    return div;
}

function placeCard(index) {
    if (state.gameStarted || !state.selectedCard) return;
    state.player.field[index] = state.selectedCard;
    state.player.hand = state.player.hand.filter(c => c !== state.selectedCard);
    state.selectedCard = null;
    render();
}

// 【修正】配置中のキャンセル機能
function handleFieldClick(card, index) {
    if (!state.gameStarted) {
        state.player.field[index] = null;
        state.player.hand.push(card);
        addLog(`${card.rank}を手札に戻しました。`);
    } else {
        // 攻撃するカードを選択
        if (state.player.attackedIds.includes(card.id)) {
            addLog("そのカードはもう攻撃済みです。");
            return;
        }
        state.selectedCard = card;
        addLog(`${card.rank}でどこを攻撃しますか？`);
    }
    render();
}

function handleAttack(targetCard) {
    if (!state.gameStarted || state.turn !== 'player' || !state.selectedCard) return;
    
    const attacker = state.selectedCard;
    const attackerIdx = state.player.field.indexOf(attacker);
    
    // 二重攻撃防止のチェック
    if (state.player.attackedIds.includes(attacker.id)) return;
    
    // 後衛攻撃制限
    if (attackerIdx >= 3) {
        addLog("後衛からは攻撃できません！");
        return;
    }

    // ダメージ計算（数字そのまま）
    targetCard.hp -= attacker.value;
    state.player.attackedIds.push(attacker.id); // 攻撃済みに登録
    addLog(`${attacker.rank}の攻撃！${attacker.value}ダメージ！`);

    if (targetCard.hp <= 0) {
        const idx = state.opponent.field.indexOf(targetCard);
        state.opponent.field[idx] = null;
        addLog("相手のカードを倒しました！");
    }
    
    state.selectedCard = null;
    render();
}

function init() {
    const suits = ['fire', 'water', 'wind', 'earth'];
    const ranks = ['A', 'K', 'Q', 'J', '9'];
    for(let i=0; i<5; i++) {
        state.player.hand.push(new Card(suits[i%4], ranks[i]));
        state.opponent.field[i] = new Card(suits[(i+2)%4], ranks[4-i]);
    }
    render();
}

document.getElementById('ok-btn').onclick = () => {
    state.gameStarted = true;
    document.getElementById('ok-btn').style.display = 'none';
    document.getElementById('end-turn-btn').style.display = 'inline';
    addLog("バトル開始！");
};

document.getElementById('end-turn-btn').onclick = () => {
    state.player.attackedIds = []; // 攻撃済みリストをリセット
    addLog("次のターンです。");
    render();
};

init();
</script>
</body>
</html>