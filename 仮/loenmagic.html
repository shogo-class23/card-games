<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Roen Card Game - Integrated Edition</title>
    <style>
        :root {
            --fire-color: #FF7B7B; --water-color: #7B8CFF;
            --wind-color: #7BFFB8; --earth-color: #C19A6B;
            --card-width: 90px;
            --card-height: 130px;
        }
        body { background-color: #2D2D2D; color: #F0F0F0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; margin: 0; overflow: hidden; }
        .game-container { width: 100%; max-width: 1100px; display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        /* フィールド: 3x2のグリッド */
        .field { 
            display: grid; 
            grid-template-areas: "slot5 slot4 slot3" "slot2 slot1 slot0"; 
            gap: 12px; padding: 15px; justify-content: center; background: rgba(0,0,0,0.3); border-radius: 10px;
        }
        .field.opponent-field-layout { grid-template-areas: "slot0 slot1 slot2" "slot3 slot4 slot5"; }
        .card-slot { width: var(--card-width); height: var(--card-height); background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; justify-content: center; align-items: center; position: relative; border: 1px dashed rgba(255,255,255,0.2); }
        
        /* カード基本デザイン */
        .card { 
            width: 100%; height: 100%; border-radius: 8px; color: #111; cursor: pointer; 
            position: relative; box-sizing: border-box; display: flex; flex-direction: column;
            justify-content: space-between; padding: 10px; font-weight: bold;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5); font-size: 0.95em; transition: 0.2s;
        }
        .card.fire { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .card.water { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
        .card.wind { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .card.earth { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .card.back { background: #555; border: 2px solid #333; }

        .card.selected { outline: 4px solid gold; transform: scale(1.05); z-index: 50; }
        .card.attacked { filter: grayscale(1) opacity(0.5); cursor: default; }

        .rank-top { font-size: 1.5em; }
        .hp-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 5px; font-size: 0.8em; }
        
        .player-hand, .opponent-hand-area { height: 160px; display: flex; justify-content: center; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); }
        .log-area { position: absolute; left: 10px; top: 10px; width: 240px; height: 200px; background: rgba(0,0,0,0.85); font-size: 12px; overflow-y: auto; padding: 10px; border-radius: 8px; border: 1px solid #444; z-index: 100; }
        
        .info-row { display: flex; justify-content: space-around; align-items: center; padding: 10px; background: #1a1a1a; }
        .pile-box { width: 50px; height: 70px; background: #444; border: 2px solid #666; border-radius: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.7em; }

        .control-lane { display: flex; justify-content: space-around; align-items: center; background: #111; padding: 20px; border-top: 2px solid #333; }
        .score-display { font-size: 2.5em; font-weight: bold; }
        .game-button { padding: 12px 24px; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 8px; font-weight: bold; }
        .game-button:disabled { background: #555; cursor: not-allowed; }
        .power-btn { background: #f1c40f; color: #333; }
    </style>
</head>
<body>

<div class="game-container">
    <div id="log-area" class="log-area"><strong>GAME LOG</strong></div>
    
    <div id="opponent-hand" class="opponent-hand-area"></div>
    <div id="opponent-field" class="field opponent-field-layout"></div>

    <div class="info-row">
        <div class="pile-box">DECK<br><span id="opp-deck">20</span></div>
        <div class="pile-box">GRAVE<br><span id="opp-grave">0</span></div>
        <div style="color:gold">ENEMY POWER: <span id="opp-power">5</span></div>
    </div>

    <div class="control-lane">
        <div class="score-display" style="color:#e74c3c" id="opp-hp">HP: 20</div>
        <div style="text-align:center;">
            <div id="status-text" style="color:yellow; font-weight:bold; margin-bottom:10px;">SETUP PHASE</div>
            <button id="ok-btn" class="game-button">READY</button>
            <div id="battle-controls" style="display:none; gap: 20px;">
                <button id="power-btn" class="game-button power-btn">POWER</button>
                <button id="end-turn-btn" class="game-button">END TURN</button>
            </div>
        </div>
        <div class="score-display" style="color:#3498db" id="ply-hp">HP: 20</div>
    </div>

    <div class="info-row">
        <div style="color:gold">PLAYER POWER: <span id="ply-power">5</span></div>
        <div class="pile-box">GRAVE<br><span id="ply-grave">0</span></div>
        <div class="pile-box">DECK<br><span id="ply-deck">20</span></div>
    </div>

    <div id="player-field" class="field"></div>
    <div id="player-hand" class="player-hand"></div>
</div>

<script>
const RANK_VALUES = { 'A': 14, 'K': 13, 'Q': 12, 'J': 11, '10': 10, '9': 9, '8': 8, '7': 7, '6': 6, '4': 4, '3': 3 };

class Card {
    constructor(suit, rank) {
        this.id = Math.random().toString(36).substr(2, 9);
        this.suit = suit; this.rank = rank;
        this.value = RANK_VALUES[rank];
        this.hp = this.value; this.maxHp = this.value;
        this.attachedPower = 0;
        this.requiredPower = this.value >= 13 ? 3 : this.value >= 9 ? 2 : 1;
    }
}

const state = {
    player: { hand: [], field: Array(6).fill(null), deck: 20, grave: 0, power: 5, hp: 20, attackedIds: [], powerInjected: false },
    opponent: { handCount: 5, field: Array(6).fill(null), deck: 20, grave: 0, power: 5, hp: 20 },
    selectedCard: null, turn: 'player', canPlaceCard: true, gameOver: false
};

function addLog(msg) {
    const log = document.getElementById('log-area');
    log.innerHTML += `<div>> ${msg}</div>`;
    log.scrollTop = log.scrollHeight;
}

function render() {
    renderField('player-field', state.player.field, false);
    renderField('opponent-field', state.opponent.field, true);
    
    const handEl = document.getElementById('player-hand');
    handEl.innerHTML = '';
    state.player.hand.forEach(card => {
        const el = createCardEl(card);
        el.onclick = () => { if(!state.gameOver) { state.selectedCard = card; render(); } };
        if (state.selectedCard === card) el.classList.add('selected');
        handEl.appendChild(el);
    });

    const oppHandEl = document.getElementById('opponent-hand');
    oppHandEl.innerHTML = '';
    for(let i=0; i<state.opponent.handCount; i++) {
        const back = document.createElement('div'); back.className = 'card back';
        oppHandEl.appendChild(back);
    }

    document.getElementById('opp-deck').textContent = state.opponent.deck;
    document.getElementById('opp-grave').textContent = state.opponent.grave;
    document.getElementById('opp-power').textContent = state.opponent.power;
    document.getElementById('opp-hp').textContent = `HP: ${state.opponent.hp}`;
    document.getElementById('ply-deck').textContent = state.player.deck;
    document.getElementById('ply-grave').textContent = state.player.grave;
    document.getElementById('ply-power').textContent = state.player.power;
    document.getElementById('ply-hp').textContent = `HP: ${state.player.hp}`;

    document.getElementById('ok-btn').style.display = state.canPlaceCard ? 'inline-block' : 'none';
    document.getElementById('battle-controls').style.display = state.canPlaceCard ? 'none' : 'flex';
    document.getElementById('power-btn').disabled = state.player.powerInjected;
}

function renderField(id, field, isOpponent) {
    const el = document.getElementById(id); el.innerHTML = '';
    field.forEach((card, i) => {
        const slot = document.createElement('div'); slot.className = 'card-slot'; slot.style.gridArea = `slot${i}`;
        if (card) {
            const cardEl = createCardEl(card);
            if (!isOpponent && state.player.attackedIds.includes(card.id)) cardEl.classList.add('attacked');
            if (state.selectedCard === card) cardEl.classList.add('selected');
            cardEl.onclick = (e) => {
                e.stopPropagation();
                if (state.gameOver) return;
                if (isOpponent) handleAttack(card);
                else handleFieldClick(card, i);
            };
            slot.appendChild(cardEl);
        } else {
            if (state.canPlaceCard && !isOpponent) slot.onclick = () => placeCard(i);
        }
        el.appendChild(slot);
    });
}

function createCardEl(card) {
    const div = document.createElement('div'); div.className = `card ${card.suit}`;
    div.innerHTML = `<div class="hp-badge">${card.hp}</div><div class="rank-top">${card.rank}</div><div style="text-align:center">${card.suit.toUpperCase()}</div><div style="font-size:0.7em">PWR: ${card.attachedPower}/${card.requiredPower}<br>ATK: ${card.value + card.attachedPower}</div>`;
    return div;
}

function placeCard(i) {
    if (!state.selectedCard || !state.player.hand.includes(state.selectedCard)) return;
    state.player.field[i] = state.selectedCard;
    state.player.hand = state.player.hand.filter(c => c !== state.selectedCard);
    state.selectedCard = null; render();
}

function handleFieldClick(card, i) {
    if (state.canPlaceCard) {
        state.player.hand.push(card);
        state.player.field[i] = null;
    } else { state.selectedCard = card; }
    render();
}

document.getElementById('power-btn').onclick = () => {
    if (state.player.powerInjected || !state.selectedCard || !state.player.field.includes(state.selectedCard)) return;
    if (state.selectedCard.attachedPower < state.selectedCard.requiredPower) {
        state.selectedCard.attachedPower++;
        state.player.powerInjected = true;
        addLog(`${state.selectedCard.rank}にパワー注入。ターン内再使用不可。`);
        render();
    }
};

function handleAttack(target) {
    if (state.turn !== 'player' || !state.selectedCard || state.player.attackedIds.includes(state.selectedCard.id)) return;
    const attacker = state.selectedCard;
    if (attacker.attachedPower < attacker.requiredPower) return;

    const dmg = attacker.value + attacker.attachedPower;
    target.hp -= dmg;
    state.player.attackedIds.push(attacker.id);
    addLog(`${attacker.rank}の攻撃、${dmg}ダメージ。`);

    if (target.hp <= 0) {
        state.opponent.field[state.opponent.field.indexOf(target)] = null;
        state.opponent.grave++;
        addLog(`敵のカードを撃破。`);
    }
    state.selectedCard = null; render();
    checkWin();
}

document.getElementById('ok-btn').onclick = () => {
    state.canPlaceCard = false;
    addLog("バトルフェーズ開始");
    render();
};

document.getElementById('end-turn-btn').onclick = () => {
    state.player.powerInjected = false;
    state.player.attackedIds = [];
    state.turn = 'opponent';
    render();
    setTimeout(opponentAI, 800);
};

function opponentAI() {
    const cards = state.opponent.field.filter(c => c !== null);
    if (cards.length > 0) {
        const c = cards[0];
        if (c.attachedPower < c.requiredPower) c.attachedPower++;
        
        const targets = state.player.field.filter(p => p !== null);
        if (targets.length > 0) {
            targets[0].hp -= (c.value + c.attachedPower);
            if (targets[0].hp <= 0) { state.player.field[state.player.field.indexOf(targets[0])] = null; state.player.grave++; }
        } else { state.player.hp--; }
    }
    state.turn = 'player';
    addLog("プレイヤーのターン開始。");
    render();
    checkWin();
}

function checkWin() {
    if (state.opponent.field.every(c => c === null)) state.opponent.hp = 0;
    if (state.opponent.hp <= 0) { alert("YOU WIN"); state.gameOver = true; }
    if (state.player.hp <= 0) { alert("GAME OVER"); state.gameOver = true; }
}

function init() {
    const suits = ['fire', 'water', 'wind', 'earth'];
    const ranks = ['A', 'K', 'Q', 'J', '10', '9'];
    for(let i=0; i<5; i++) state.player.hand.push(new Card(suits[i%4], ranks[i]));
    for(let i=0; i<3; i++) state.opponent.field[i] = new Card(suits[(i+2)%4], ranks[5-i]);
    render();
}
init();
</script>
</body>
</html>